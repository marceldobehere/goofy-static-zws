<html>
<head>
    <meta charset="UTF-8">
    <title>Goofy ZWS</title>
    <style>
        html {
            background: rgb(0, 31, 45);
            color: #f8ffff;
        }

        a {
            color: #4dfff3;
        }

        :root {
            --show1: none;
            --show2: block;
        }

        #thanks {
            display: var(--show1);
            width: fit-content;
            margin: auto;
            text-align: center;
        }

        #main {
            display: var(--show2);
            width: fit-content;
            margin: auto;
            text-align: center;
        }
    </style>
</head>
<body>
<script>
    const currentUrl = decodeURIComponent(document.location.href);
    const start = currentUrl.indexOf("#");
    if (start !== -1)
        document.documentElement.style.cssText = "--show1: block; --show2: none;";
</script>

<div id="thanks">
    <h1>Thank you for using Goofy Link Shortener</h1>
    <p>Redirecting to <a id="redirect"></a></p>
</div>

<div id="main">
    <h1>Goofy Link Shortener</h1>
    <br>

    <input id="link" placeholder="https://example.com">
    <button id="btn" onclick="shortenLink()">Submit</button>
    <br>
    <br>
    <br>
    <a href="https://github.com/marceldobehere/goofy-static-zws" target="_blank">Source</a>
</div>


<script>
    const DEFAULT_SHORT_CHARS = [
        '\uDB40\uDC61',
        '\uDB40\uDC62',
        '\uDB40\uDC63',
        '\uDB40\uDC64',
        '\uDB40\uDC65',
        '\uDB40\uDC66',
        '\uDB40\uDC67',
        '\uDB40\uDC68',
        '\uDB40\uDC69',
        '\uDB40\uDC6A',
        '\uDB40\uDC6B',
        '\uDB40\uDC6C',
        '\uDB40\uDC6D',
        '\uDB40\uDC6E',
        '\uDB40\uDC6F',
        '\uDB40\uDC70',
    ];
    const ALLOWED_INVIS_CHARS = DEFAULT_SHORT_CHARS.join("");
    const ALLOWED_TEXT_CHARS = "abcdefghijklmnopqrstuvwxyz0123456789_-";

    const hexChars = "0123456789abcdef";

    const linkElem = document.getElementById("link");
    linkElem.value = "";
    const redirectElem = document.getElementById("redirect");

    function hexEncode(str) {
        let hex, i;

        let result = "";
        for (i = 0; i < str.length; i++) {
            hex = str.charCodeAt(i).toString(16);
            result += ("000" + hex).slice(-4);
        }

        return result
    }

    function hexDecode(str) {
        let j;
        let hexes = str.match(/.{1,4}/g) || [];
        let back = "";
        for (j = 0; j < hexes.length; j++) {
            back += String.fromCharCode(parseInt(hexes[j], 16));
        }

        return back;
    }

    function filter (inputStr, allowedChars) {
        return inputStr.split("").filter(char => allowedChars.includes(char)).join("");
    }

    function shortenLink() {
        const srcLink = linkElem.value;
        console.log(srcLink);

        const shortenedPart = shorten(srcLink);
        const firstPart = (start == -1) ? currentUrl : currentUrl.substring(0, start);

        const extraText = prompt("If you want, you can add a normal link text here") || "";

        const result = firstPart + "#" + shortenedPart + filter(extraText.toLowerCase().replaceAll(" ", "-"), ALLOWED_TEXT_CHARS);
        console.log("Result: ", result)
        navigator.clipboard.writeText(result);
        alert("Link has been copied to clipboard");
    }

    function shorten(link) {
        const hex = hexEncode(link);
        console.log(link, hex);
        let res = "";
        for (let i = 0; i < hex.length; i++) {
            const c = hex.charAt(i);
            const idx = hexChars.indexOf(c);
            const nC = DEFAULT_SHORT_CHARS[idx];
            //console.log("> " + c + ": " + idx + " -> " + nC)
            res += nC;
        }
        return res;
    }

    function unshorten(txt) {

        let res = "";
        for (let i = 0; i < txt.length; i += 2) {
            const c = txt.charAt(i) + txt.charAt(i + 1);
            const idx = DEFAULT_SHORT_CHARS.indexOf(c);
            const nC = hexChars[idx];
            // console.log("> " + c + ": " + idx + " -> " + nC)
            res += nC;
        }
        // console.log(res);
        res = hexDecode(res);
        // console.log(res);
        return res;
    }

    function checkUrl() {
        console.log(currentUrl);
        if (start == -1)
            return;
        const extra = currentUrl.substring(start + 1);
        if (extra.length == 0)
            return;
        // console.log("Short: " + extra);

        const result = unshorten(filter(extra, ALLOWED_INVIS_CHARS));
        console.log("Going to: " + result);
        redirectElem.textContent = result;
        redirectElem.href = result;
        // window.location.replace(result);
    }

    checkUrl();
</script>
</body>
</html>